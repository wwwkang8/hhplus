## 시나리오 요구사항 분석(콘서트 예약시스템)
[유저 대기열 API]
- 토큰 발급 및 대기열 추가 : UUID + 유저 아이디 + wait_no
- 대기열 검증 : 토근 발급 이후, 모든 API 요청은 대기열에 해당 사용자가 존재하는지 검증
- (폴링) 대기열 상태 확인 : 폴링 방식으로 현재 유저의 대기상태 확인. @Schedule 스케쥴러로 매 시간마다 확인 후 갱신
** 매 분마다 N명씩 추가로 입장 가능하도록 개발

[예약가능날짜/좌석 API]
- 예약가능일자 조회 : 예약 가능한 날짜 조회 기능
- 좌석정보 조회 : 해당 날짜의 좌석정보 조회 기능(1~50번의 좌석번호 반환)

[좌석예약요청 API]
- 좌석 예약 기능 : 좌석번호, 날짜를 입력 받아 예약
- 임시 배정 기능 : 좌석 예약시 5분간 사용자에게 배정. 5분이 지나면 다른 사용자에게 좌석조회시 보여지게 됨.

[잔액 충전/조회 API]
- 잔액 충전 : 사용자 식별자(아이디), 충전할 금액 받아서 충전
- 잔액 조회 : 사용자 식별자(아이디)로 잔액 조회

[결제 API]
- 결제 : 사용자의 잔액을 사용하여 결제처리 하고, 결제내역 생성.
- 대기열 만료 : 사용자에게 좌석 배정 후, 대기열 만료처리.

## 시퀀스 다이어그램
![image](https://github.com/wwwkang8/hhplus/assets/26863285/55d3efb0-1508-4812-af52-7d6ea093fd18)



## 아키텍쳐
- 레이어드 아키텍쳐 + 클린 아키텍쳐
- 도메인별로 다른 패키지 구조를 설계.
- 추후 Service 로직이 비대해지는 것을 방지하기 위해서 Usecase 모델을 추가.
  Controller --> Usecase --> Repository 방향으로 단방향 호출 방식

## API 명세

### [1. 대기열 진입]
사용자가 대기열에 진입합니다. 진입시 토큰, 사용자ID, 대기번호를 발급 받습니다.
| 메서드 | 요청 URL | 기능 |
|--------|-----------------| -----------|
| POST    |/api/queue/     | 대기열 진입   |

Request
| 파라메터 | 타입 | 필수여부 | 설명 |
|--------|----------| ----------|----------|
| 없음     |         |           |          |

Response
| 필드 | 타입 | 필수여부 | 설명 |
|--------|----------------|-----|------------------|
| token  |String    |필수  |토큰|
| userId |String    |필수  |사용자ID|
| waitNo |String    |필수  |대기순번|

### [1-1. 대기열 순번 조회]
대기열 순번을 조회하는 폴링 API

| 메서드 | 요청 URL | 기능 |
|--------|-----------------| -----------|
| GET    |/api/queue/{userId}| 대기열 순번 조회 |

Request
| 파라메터 | 타입 | 필수여부 | 설명 |
|--------|----------| ----------|----------|
| userId |String    |필수        |사용자의 대기순번 조회|

Response
| 필드 | 타입 | 필수여부 | 설명 |
|--------|----------------|-----|------------------|
| token  |String    |필수  |토큰|
| userId |String    |필수  |사용자ID|
| waitNo |String    |필수  |대기순번|



### [2. 예약 가능 날짜조회]
좌석 예약이 가능한 날짜를 조회합니다.

| 메서드 | 요청 URL | 기능 |
|--------|-----------| -----------|
| GET    |/api/seat  | 예약가능날짜조회|

Request
| 파라메터 | 타입 | 필수여부 | 설명 |
|--------|----------| ----------|----------|
| 없음     |         |           |          |

현재 시점에서 예약 가능한 콘서트의 모든 날짜를 리턴. 따라서 파라메터를 따로 입력받지 않습니다.

Response
| 필드 | 타입 | 필수여부 | 설명 |
|--------|----------------|-----|------------------|
| date   |List<String>    |필수  |예약 가능한 날짜|

### [3. 특정날짜의 예약가능한 좌석조회]
| 메서드 | 요청 URL | 기능 |
|--------|------------------|-----------------------|
| GET     |/api/seat/{date} | 해당날짜의 예약가능한 좌석조회|

Request
| 파라메터 | 타입 | 필수여부 | 설명 |
|--------|----------|-----|----------|
| date   |  String  | 필수 |   예약날짜|

Response
| 필드 | 타입 | 필수여부 | 설명 |
|--------|----------------|-----|-------------------|
| seat   |List<String>    |필수  |예약 가능한 좌석번호리스트|


### [4. 좌석 예약]
| 메서드 | 요청 URL | 기능 |
|--------|------------|----------|
| POST   |/api/reservation/| 티켓예약 |

Request
| 파라메터 | 타입 | 필수여부 | 설명 |
|--------|----------|-----|----------|
|userId |String| 필수 |사용자아이디|
|date   |String| 필수 |예약날짜|
|seatNo|String| 필수 |좌석번호|

Response
| 필드 | 타입 | 필수여부 | 설명 |
|--------|----------------|-----|-------------------|
| seatNo|String    |필수  |임시배정된 좌석번호|
| expiredAt|String    |필수  |임시배정된 좌석만료시각|

### [5. 포인트 조회]
| 메서드 | 요청 URL | 기능 |
|--------|----------|----------|
| GET     |/api/point/{userId}| 포인트 조회|

Request
| 파라메터 | 타입 | 필수여부 | 설명 |
|--------|----------|-----|----------|
|userId |String| 필수 |사용자아이디|

Response
| 필드 | 타입 | 필수여부 | 설명 |
|--------|--------|-----|--------|
| point|Integer |필수  |포인트 잔액|

### [6. 포인트 충전]
| 메서드 | 요청 URL |기능|
|--------|----------|----------|
| POST     |/api/point/charge| 포인트 충전   |

Request
| 파라메터 | 타입 | 필수여부 | 설명 |
|--------|----------|-----|----------|
|userId |String| 필수 |사용자아이디|
|amount |Integer| 필수 |충전할 포인트 금액|

Response
| 필드 | 타입 | 필수여부 | 설명 |
|--------|--------|-----|--------|
| point|Integer |필수  |포인트 잔액|

### [7. 결제]
| 메서드 | 요청 URL |기능|
|--------|----------|----------|
| POST     |/api/payment/| 결제  |

Request
| 파라메터 | 타입 | 필수여부 | 설명 |
|-----------|----------|-----|----------|
|userId |String| 필수 |사용자아이디|
|date |String| 필수 |예약 날짜|
|seatNo |String| 필수 |예약 좌석번호|

Response
| 필드 | 타입 | 필수여부 | 설명 |
|--------|--------|-----|--------|
| result|String |필수  |좌석예약 성공여부|

## ERD 구조
![image](https://github.com/wwwkang8/hhplus/assets/26863285/aa7742d6-8f7b-43c6-9858-c7d6f5789b33)


1) 사용자 테이블뿐만 아니라 대기열 테이블에도 사용자 아이디를 넣은 이유는 대기열 테이블의 경우 대기상태를 계속해서 체크해야 하므로
조회 거래가 많을 것으로 예상된다. 다른 테이블과 JOIN을 하여 성능을 저하시키기보다는 애초에 대기열 테이블에 토큰을 넣는 것이 효율적이라고 판단.
2) 대기열 테이블 : 사용자가 예약시스템 접속시 사용자ID가 생성되고, 동시에 토큰 발급한다. 그리고 토큰의 유효시간을 둬서 예약을 중도포기하는 사용자를 대기열에서 제거
3) 사용자 테이블 : 사용자테이블에는 아이디와 포인트 잔액이 존재. 토큰이 대기열, 사용자 테이블 모두에 있는 이유는 JOIN을 최소화 하기 위함.
4) 예약 테이블 : 예약테이블은 좌석 결제를 마친 후에 데이터가 생성되는 테이블. 결제내역 테이블과 동일한 기능.
5) 공연 테이블 : 공연아이디와 좌석번호를 PK로 묶어서, 한 공연당 50개의 데이터 ROW가 쌓여야 한다. 그리고 임시배정만료시각이 있어서 이 필드로 좌석 배정가능여부를 판단.
6) 공연 테이블은 공연, 좌석 테이블을 따로 나누면 JOIN으로 인한 성능 저하게 있다고 판단하여 같은 테이블 안에 공연정보를 넣는 것으로 결정.
   이러한 구조 때문에 동시성 제어할 경우에는 ConcurrentHashMap 사용해야할 것으로 판단. 비관적락을 걸어버리면 테이블 전체에 조회도 못하게 락을 걸기 때문에
   성능이 떨어질 가능성이 높다.


## 구현 방식에 대한 고민
### 1. 유저 대기열 토큰 기능
- 예약 요청이 들어올 때 Interceptor를 이용해서 먼저 헤더에 토큰이 있는지 여부를 검증
- 헤더에 토큰이 없으면 => 토큰 발급, 토큰이 있다면 => Token 테이블에서 사용자 조회
- 토큰 발급 : UUID를 생성할 때, 사용자 아이디 + 생성시각 + 만료시각을 넣어서 생성한다.
- 토큰 발급 후 해당 사용자는 Token 테이블에 INSERT.
- 현재 "예약중" 상태인 사용자가 50명이 넘으면, 51번째 사용자부터는 "대기"

### 2. 좌석 임시배정
- 사용자가 좌석을 선택했을 때 공연테이블에 사용자 아이디, 임시배정만료시각을 세팅
- 좌석조회 시에 좌석상태값, 임시배정만료시각을 고려하여 조회한다. => 이렇게 하면 따로 좌석에 대한 갱신처리를 안해도 됨
- 좌석 예약의 동시성 제어는 ConcurrentHashMap으로 하여 좌석별로 Lock을 걸어서 공연테이블 전체의 성능저하를 방지한다.
- 사용자 A가 좌석을 임시배정 받았는데, 임시배정시간이 지난 경우?
  1) 다른 사용자 B가 임시배정 받았을 때 : 공연테이블에 있는 임시배정된 사용자 아이디를 먼저 비교해서 같은지 검증. 다르면 실패처리
  2) 아무도 임시배정을 받지 않았을 때 : 임시배정만료시각으로 비교해서 A 사용자는 좌석비교 불가. 첨부터 다시 해야함.
